# Tesla Wall Connector Dashboard Configuration
#
# QUICK START:
#   Just run: docker-compose up -d
#   Works out of the box with default credentials below.
#
# CUSTOM SETUP (optional):
#   cp .env.example .env
#   Edit .env with your values
#   docker-compose up -d

# =============================================================================
# INFLUXDB CONFIGURATION
# =============================================================================
# InfluxDB stores all time-series data (charger metrics, pricing, sessions)
# These credentials are used on first startup to initialize the database
# After initial setup, changing these won't affect existing data
#
# For production: Change these values to secure passwords/tokens
# Generate a token with: openssl rand -hex 32

INFLUXDB_ADMIN_USER=admin
INFLUXDB_ADMIN_PASSWORD=changeme
INFLUXDB_ORG=home
INFLUXDB_BUCKET=twc_dashboard

# Token used by collector and Grafana to access InfluxDB
INFLUXDB_ADMIN_TOKEN=twc-dashboard-token

# =============================================================================
# GRAFANA CONFIGURATION
# =============================================================================
# Grafana provides the web dashboard interface
# Access at http://localhost:3080 after startup
# Default login: admin / changeme

GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=changeme

# =============================================================================
# TESLA WALL CONNECTOR(S)
# =============================================================================
# How to find your Wall Connector IP:
#   1. Check your router's DHCP client list for "Tesla Wall Connector"
#   2. Use a network scanner app (e.g., Fing, Advanced IP Scanner)
#   3. Check your router's admin page for connected devices
#
# Tip: Set a static IP or DHCP reservation for your Wall Connector
# so the address doesn't change.
#
# Test connectivity:
#   curl http://YOUR_IP/api/1/vitals
#   Should return JSON with power, voltage, temperature data
#
# Format: name:ip (name is your label, used in Grafana dropdowns)
# Single charger example:
TWC_CHARGERS=garage:192.168.1.100

# Multiple chargers (comma-separated):
# TWC_CHARGERS=garage_left:192.168.1.100,garage_right:192.168.1.101

# Power Sharing Note:
# When using TWC power sharing, only the LEADER unit is accessible via API.
# Follower units connect to the leader via a private 192.168.92.x network
# and cannot be polled directly. Only add the leader's IP here.
#
# For multi-unit setups, use Fleet API (via Tessie) to monitor all units.

# -----------------------------------------------------------------------------
# Local TWC API Control (Legacy)
# -----------------------------------------------------------------------------
# The local Wall Connector API is now legacy and optional.
# Set to false to disable local API polling entirely (saves resources).
#
# When to disable:
#   - You're using Fleet API for Wall Connector monitoring (recommended)
#   - You only need vehicle data and pricing, not charger diagnostics
#
# When to keep enabled:
#   - You want to use the legacy Live Overview dashboard
#   - You want diagnostic data (temperatures, WiFi signal, grid voltage)
#   - You don't have Tessie or Fleet API configured
#
# Default: true (for backwards compatibility)
LOCAL_TWC_ENABLED=true

# =============================================================================
# POLLING INTERVALS (seconds)
# =============================================================================
# How often to fetch data from each source
# Lower values = more data points but higher network/CPU usage
#
# NOTE: Default intervals have been increased since Fleet API is now the
# primary data source for Wall Connector monitoring. These intervals are
# appropriate for diagnostic/legacy data collection.
#
# If you're NOT using Fleet API and rely on local TWC polling, you may want
# to lower these intervals for more responsive dashboards:
#   TWC_POLL_VITALS_INTERVAL=5
#   TWC_POLL_LIFETIME_INTERVAL=60
#   TWC_POLL_WIFI_INTERVAL=60

# Real-time vitals (power, voltage, current, temperature, session info)
# Default: 30 seconds (legacy diagnostics)
# For primary monitoring without Fleet API: 5 seconds recommended
TWC_POLL_VITALS_INTERVAL=30

# Lifetime statistics (total energy, session count, uptime)
# Default: 300 seconds (5 minutes)
# For primary monitoring without Fleet API: 60 seconds recommended
TWC_POLL_LIFETIME_INTERVAL=300

# Firmware version info
# Rarely changes, 5 minutes is fine
TWC_POLL_VERSION_INTERVAL=300

# WiFi status and signal strength
# Default: 300 seconds (5 minutes)
# For primary monitoring without Fleet API: 60 seconds recommended
TWC_POLL_WIFI_INTERVAL=300

# =============================================================================
# COMED HOURLY PRICING
# =============================================================================
# ComEd Hourly Pricing is a program for Illinois customers that charges
# real-time electricity rates instead of a fixed rate.
#
# If you're a ComEd Hourly Pricing customer:
#   - Set COMED_ENABLED=true
#   - Dashboard will show real-time prices and calculate charging costs
#   - Learn more: https://hourlypricing.comed.com/
#
# If you're NOT a ComEd customer or not on hourly pricing:
#   - Set COMED_ENABLED=false
#   - Price panels will show "No data" (this is normal)
#   - Charger monitoring will still work

COMED_ENABLED=true
COMED_POLL_INTERVAL=300

# -----------------------------------------------------------------------------
# ComEd Full Cost Calculation (Non-Supply Charges)
# -----------------------------------------------------------------------------
# The ComEd Hourly Pricing API only returns the SUPPLY rate (electricity
# generation cost). Your actual bill includes additional charges that we
# bundle into a single "delivery rate" for simplicity.
#
# IMPORTANT: The delivery rate should include ALL non-supply charges:
#
#   DELIVERY SERVICES (per kWh):
#     - Electricity Distribution Charge
#     - Transmission Services Charge
#     - Purchased Electricity Adjustment
#     - Environmental Cost Recovery
#     - Energy Efficiency Programs
#     - Misc Procurement Component
#
#   CAPACITY CHARGE:
#     - This is a $/kW charge based on your peak usage during PJM peak hours
#     - ComEd's website notes: "kWh prices do not include your personal
#       Capacity Charge"
#     - To estimate: Take your monthly capacity charge ÷ monthly kWh
#     - Example: $15 capacity charge ÷ 500 kWh = 3¢/kWh to add
#
#   TAXES & FEES (per kWh):
#     - State/local taxes
#     - Various regulatory fees
#
# How to calculate your total non-supply rate from your ComEd bill:
#   1. Find your total bill amount
#   2. Subtract the "Electricity Supply" charges (hourly pricing portion)
#   3. Subtract any fixed monthly charges (customer charge, metering)
#   4. Divide remainder by kWh used = your non-supply rate per kWh
#
# Based on analysis of several months of ComEd bills, typical values:
#   - Delivery + capacity + taxes: 7-9 cents/kWh (varies by usage pattern)
#   - Monthly fixed charges: $19-20 (customer charge + metering)
#
# Note: Capacity charges vary based on your peak usage, so this is an
# approximation. High-usage customers may have higher effective rates.
#
# You can also adjust the delivery_rate variable directly in Grafana
# dashboards without restarting services.

COMED_DELIVERY_PER_KWH=0.075
COMED_MONTHLY_FIXED=19.56

# =============================================================================
# COMED OPOWER (Actual Meter Data via ComEd Portal)
# =============================================================================
# Opower integration fetches your actual electricity usage and cost data
# directly from ComEd's portal. This is the same data that appears on your
# monthly bill, including all fees, delivery charges, and taxes.
#
# Use cases:
#   - Bill reconciliation (compare calculated vs. actual costs)
#   - Accurate effective rates (see your true $/kWh)
#   - Historical usage data (daily, hourly, or 30-minute resolution)
#   - Monthly bill tracking
#
# IMPORTANT: Initial authentication requires MFA (Multi-Factor Authentication).
# You must run the setup script first to authenticate and cache credentials:
#
#   python scripts/comed_auth.py --daemon
#
# This will:
#   1. Prompt for your ComEd username/password
#   2. Send an MFA code to your email or phone
#   3. Cache the session for the collector to use
#
# Alternative: If you prefer not to store credentials, you can:
#   1. Log into secure.comed.com in your browser
#   2. Navigate to "View My Usage"
#   3. Open browser DevTools → Network tab
#   4. Copy the Authorization header from any cec.opower.com request
#   5. Set COMED_BEARER_TOKEN in .secrets
#
# Note: Bearer tokens expire when your browser session ends.
# Credentials stored in .secrets file (NOT here) for security.

OPOWER_ENABLED=false

# Polling interval in seconds (default: 3600 = 1 hour)
# ComEd meter data typically updates once per day, so frequent polling isn't needed
OPOWER_POLL_INTERVAL=3600

# MFA method: "email" or "sms"
OPOWER_MFA_METHOD=email

# =============================================================================
# TESSIE API (Tesla Vehicle Integration)
# =============================================================================
# Tessie provides access to Tesla's Fleet API for vehicle data and control.
# Requires a Tessie account with an active subscription.
#
# With Tessie Pro Lifetime, you get:
#   - Unlimited vehicle data polling at no cost
#   - Access to Tesla Fleet API, Fleet Telemetry, and Tessie APIs
#   - Automatic vehicle wake-up and error handling
#   - Charging history with costs and locations
#
# Benefits for this dashboard:
#   - See vehicle battery SOC, range, and charging status
#   - Track which vehicle is charging (multi-vehicle support)
#   - Detect charging at different Wall Connectors (leader/follower setups)
#   - Control charging remotely (start/stop, set limits)
#   - Correlate vehicle charge data with TWC metrics
#
# Setup:
#   1. Create account at https://tessie.com/
#   2. Generate API token at https://dash.tessie.com/settings/api
#   3. Copy .secrets.example to .secrets
#   4. Add your token to .secrets file (NOT here - keep tokens in .secrets)
#   5. Set TESSIE_ENABLED=true below
#
# IMPORTANT: The Tessie API token goes in .secrets file, NOT in .env
# This keeps sensitive tokens separate and out of environment variables.

TESSIE_ENABLED=false
TESSIE_POLL_INTERVAL=60

# =============================================================================
# FLEET API WALL CONNECTORS (Leader/Follower Power Sharing)
# =============================================================================
# If you have multiple Wall Connectors in a power-sharing setup, only the
# leader unit is accessible via the local API. The Fleet API (via Tessie)
# provides access to ALL Wall Connectors, including followers.
#
# The energy_site_id is discovered automatically if not specified.
# You can find it manually by calling: GET /api/1/products with your Tessie token
#
# Benefits:
#   - See power usage for ALL Wall Connectors (leader + followers)
#   - Track which vehicle is charging at which unit
#   - Monitor power sharing across units
#
# To enable:
#   1. Ensure TESSIE_ENABLED=true and token is in .secrets
#   2. Leave FLEET_ENERGY_SITE_ID empty for auto-discovery, or set explicitly
#   3. Restart collector

# Optional: Set explicitly if you have multiple energy sites
# If not set, the collector will auto-discover from your Tessie account
# FLEET_ENERGY_SITE_ID=2252265929402210

# Polling interval for Fleet API Wall Connector data (seconds)
# Lower values give more real-time updates but use more API calls
FLEET_TWC_POLL_INTERVAL=30

# Polling interval for Fleet API charge history (seconds)
# How often to check for newly completed charging sessions from telemetry_history.
# Note: This is a BACKUP source - sessions are recorded immediately from live_status
# but telemetry_history provides more accurate energy readings when it arrives.
# Default: 900 (15 minutes)
FLEET_CHARGE_HISTORY_INTERVAL=900

# -----------------------------------------------------------------------------
# Fleet Session Recording Thresholds
# -----------------------------------------------------------------------------
# Sessions are recorded immediately when charging stops (via live_status polling).
# These thresholds filter out brief plug-ins or connection tests.
#
# Minimum energy (kWh) to record a session (default: 0.1)
# FLEET_SESSION_MIN_ENERGY_KWH=0.1
#
# Minimum duration (seconds) to record a session (default: 60)
# FLEET_SESSION_MIN_DURATION_S=60

# -----------------------------------------------------------------------------
# Wall Connector Friendly Names
# -----------------------------------------------------------------------------
# Give friendly names to your Wall Connectors for easier identification.
# Format: serial:Name,serial:Name
#
# To find your serials, check the collector logs at startup or look at the
# DIN printed on your Wall Connector (serial is the last part after "--").
# Example DIN: 1457768-02-G--ABC12345678 → serial is ABC12345678
#
# If not set, units are named "Leader", "Follower 2", etc. based on position.
#
# Example:
# TWC_UNIT_NAMES=ABC12345678:Garage Right,DEF98765432:Garage Left
TWC_UNIT_NAMES=

# -----------------------------------------------------------------------------
# Vehicle Friendly Names
# -----------------------------------------------------------------------------
# Give friendly names to your vehicles. Used when Tessie returns empty
# display_name (e.g., when vehicles are asleep/offline).
# Format: VIN:Name,VIN:Name
#
# To find your VIN: Check your Tesla account, Tessie dashboard, or vehicle info.
#
# Example:
# VEHICLE_NAMES=5YJ3E1ECXPF000001:Model 3,5YJSA1E50NF000002:Model S
VEHICLE_NAMES=

# -----------------------------------------------------------------------------
# Target ID to Vehicle Name Mapping (Fleet API Charge History)
# -----------------------------------------------------------------------------
# The Fleet API charge history uses UUIDs (target_id) to identify vehicles,
# not VINs. This mapping converts those UUIDs to friendly vehicle names.
# Format: target_id:Name,target_id:Name
#
# To find target_ids, query InfluxDB after some charging sessions:
#   from(bucket: "twc_dashboard")
#     |> filter(fn: (r) => r._measurement == "fleet_charge_session")
#     |> keep(columns: ["target_id"])
#     |> distinct()
#
# Example:
# TARGET_ID_VEHICLES=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee:Model 3,11111111-2222-3333-4444-555555555555:Model S
TARGET_ID_VEHICLES=

# =============================================================================
# SMART CHARGING (Adaptive Price-Based Control)
# =============================================================================
# Smart charging automatically pauses/resumes vehicle charging based on
# electricity prices. Uses adaptive thresholds based on rolling 30-day
# statistics, so thresholds automatically adjust as prices trend over time.
#
# REQUIRES: TESSIE_ENABLED=true and valid Tessie API token in .secrets
#
# How it works:
#   1. On startup, fetches 30 days of historical prices from ComEd API
#   2. Calculates percentiles (e.g., 90th percentile = top 10% most expensive)
#   3. During charging, if price exceeds stop threshold → pauses charging
#   4. When price drops below resume threshold → resumes charging
#
# Example with 30-day stats:
#   - Mean: 4.2¢/kWh, 90th percentile: 8.2¢, 75th percentile: 5.8¢
#   - If price spikes to 9¢ (above 90th) → STOP charging
#   - When price drops to 5¢ (below 75th) → RESUME charging
#
# Safety features:
#   - Minimum 10-minute interval between start/stop commands (hysteresis)
#   - Only controls charging that was paused by smart charging
#   - Does not interfere with manual start/stop or scheduled charging

# Enable smart charging data collection and dashboard panels
# Set to true to see price statistics, thresholds, and recommendations
SMART_CHARGING_ENABLED=false

# Enable automatic vehicle control (start/stop charging based on price)
# Two modes:
#   false = DRY-RUN MODE (recommended for testing)
#     - Price spike detection works normally
#     - Actions logged prominently: "DRY RUN - WOULD STOP/RESUME CHARGING"
#     - Simulated actions written to InfluxDB for dashboard visibility
#     - Dashboard shows "DRY-RUN" indicator and "Would Pause" status
#     - NO commands sent to vehicle - safe to leave running indefinitely
#   true = LIVE MODE
#     - Actually sends start/stop commands to vehicle via Tessie API
#     - Only enable after validating thresholds in dry-run mode
# WARNING: When true, smart charging will send commands to your vehicle!
SMART_CHARGING_CONTROL_ENABLED=false

# Number of days of price history to use for calculating statistics
# More days = more stable thresholds, but slower to adapt to price changes
SMART_CHARGING_LOOKBACK_DAYS=30

# Stop charging when price exceeds this percentile (default: 90 = top 10%)
SMART_CHARGING_STOP_PERCENTILE=90

# Resume charging when price drops below this percentile (default: 75)
SMART_CHARGING_RESUME_PERCENTILE=75

# Minimum seconds between start/stop commands to prevent rapid cycling
SMART_CHARGING_MIN_INTERVAL=600

# =============================================================================
# TIMEZONE
# =============================================================================
# Used for time-based displays and calculations
# Full list: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones

TZ=America/Chicago
